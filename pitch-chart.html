<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Pitch Accent chart generator</title>
	<style>
		html,body {
			font-family: Roboto, sans-serif;
		}
	</style>
</head>
<body>
	<input id="pitch-input" type="text">
	<select id="particle-pitch"><option value="low" selected>Low particle</option><option value="high">High particle</option></select>
	<button id="download-image" type="button">Download PNG</button>
	<button id="copy-image" type="button">Copy image to clipboard</button>
	<select id="background-style"><option value="transparent">Transparent background</option><option value="color" selected>Background color</option></select>
	<input id="background-color" type="color" placeholder="Background color" value="#ffffff">
	<div id="pitch-chart"></div>
	<script>
		const pitchChart = document.getElementById("pitch-chart");
		const pitchInput = document.getElementById("pitch-input");
		const particlePitchInput = document.getElementById("particle-pitch");
		const downloadImageButton = document.getElementById("download-image");
		const copyImageButton = document.getElementById("copy-image");
		const backgroundStyleInput = document.getElementById("background-style");
		const backgroundColorInput = document.getElementById("background-color");
		particlePitchInput.onchange = () => refreshSvg();
		pitchInput.oninput = () => refreshSvg();
		downloadImageButton.onclick = () => downloadImage();
		copyImageButton.onclick = () => copyImageToClipboard();
		backgroundStyleInput.onchange = () => backgroundColorInput.hidden = backgroundStyleInput.value === "transparent";

		function refreshSvg()
		{
			const pitchString = pitchInput.value.toUpperCase().split("").filter(c => c === "L" || c === "H").join("");
			pitchInput.value = pitchString;
			
			const svg = generateSvg(pitchString, particlePitchInput.value);
			svg.style.height = "100px";
			pitchChart.innerHTML = "";
			pitchChart.appendChild(svg);
		}

		function generateSvg(inputString, particlePitch)
		{
			const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
			svg.setAttributeNS("http://www.w3.org/2000/xmlns/", "xmlns:xlink", "http://www.w3.org/1999/xlink");

			const horizStepSize = 36;
			const anchorRadius = 5;
			const anchorStrokeWidth = 1;
			const anchorWidth = anchorRadius  + anchorStrokeWidth;
			const yLow = "75%";
			const yHigh = "15%";

			inputString += particlePitch === "low" ? "L" : "H";

			const svgWidth = anchorWidth*2 + horizStepSize * (inputString.length - 1);
			const svgHeight = 100;
			svg.setAttribute("viewBox", `0 0 ${svgWidth} ${svgHeight}`);

			for (let i = 0; i < inputString.length; i++)
			{
				const currentChar = inputString.charAt(i);
				const nextChar = inputString.charAt(i+1);
				const y1 = currentChar === "L" ? yLow : yHigh;

				if (nextChar !== "")
				{
					const y2 = nextChar === "L" ? yLow : yHigh;
					const line = makeLine(anchorWidth + horizStepSize * i, anchorWidth + horizStepSize * (i+1), y1, y2);
					svg.appendChild(line);
				}

				const anchor = makeAnchor(anchorStrokeWidth, anchorRadius, anchorWidth + horizStepSize * i, y1, i === inputString.length - 1 ? "#ffffff" : undefined);
				svg.appendChild(anchor);
			}

			return svg;
		}

		function makeLine(x1, x2, y1, y2)
		{
			const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
			line.setAttribute("stroke", "#0cd24d");
			line.setAttribute("stroke-width", "2");
			line.setAttribute("x1", x1);
			line.setAttribute("y1", y1);
			line.setAttribute("x2", x2);
			line.setAttribute("y2", y2);

			return line;
		}

		function makeAnchor(strokeWidth, radius, cx, cy, fill="#0cd24d")
		{
			const anchor = document.createElementNS("http://www.w3.org/2000/svg", "circle");
			anchor.setAttribute("fill", fill);
			anchor.setAttribute("stroke", "#000000");
			anchor.setAttribute("stroke-width", strokeWidth + "");
			anchor.setAttribute("r", radius + "");
			anchor.setAttribute("cx", cx + "");
			anchor.setAttribute("cy", cy + "");

			return anchor;
		}

		function makePng()
		{
			const svg = document.querySelector("svg");
			const canvas = document.createElement("canvas");
			const svgBounds = svg.getBoundingClientRect();
			canvas.width = parseFloat(svgBounds.width);
			canvas.height = parseFloat(svgBounds.height);
			const context = canvas.getContext("2d");

			if (backgroundStyleInput.value === "color")
			{
				if (!backgroundColorInput.value.startsWith("#"))
					throw new Error("Background color must be a hex string");
				
				context.fillStyle = backgroundColorInput.value;
				context.fillRect(0, 0, canvas.width, canvas.height);
			}

			const image = new Image();
			const svgData = (new XMLSerializer()).serializeToString(svg);
			const svgBlob = new Blob([svgData], { type: "image/svg+xml;charset=utf-8" });
			const imageUrl = URL.createObjectURL(svgBlob);

			return new Promise(resolve =>
			{
				image.onload = () => {
					context.drawImage(image, 0, 0);
					URL.revokeObjectURL(imageUrl);
					const imageUri = canvas.toDataURL();
					resolve(imageUri);
				};
				image.src = imageUrl;
			});
		}

		function triggerDownload(uri)
		{
			const a = document.createElement("a");
			a.setAttribute("download", "pitch.png");
			a.setAttribute("href", uri);
			a.setAttribute("target", "_blank");
			a.click();
		}

		async function downloadImage()
		{
			const uri = await makePng();
			triggerDownload(uri);
		}

		async function copyImageToClipboard()
		{
			const uri = await makePng();
			const imageBlob = await fetch(uri).then(r => r.blob());

			await navigator.clipboard.write([
				new ClipboardItem({
					[imageBlob.type]: imageBlob
				})
			]);
		}
	</script>
</body>
</html>